<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Execution Layer - WETH/USDC Monitor</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f1e;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            border: 1px solid #2a2a3e;
        }

        h1 {
            color: #00d4ff;
            font-size: 24px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .pool-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #8e8ea9;
        }

        .pool-info span {
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pool-info strong {
            color: #fff;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a3e;
        }

        .card h2 {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 13px;
        }

        .stat-label {
            color: #8e8ea9;
        }

        .stat-value {
            color: #fff;
            font-weight: 600;
        }

        .price-large {
            font-size: 32px;
            font-weight: 700;
            color: #00ff88;
            margin: 12px 0;
            text-align: center;
        }

        .price-large.down {
            color: #ff4444;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-open {
            background: #00ff88;
            box-shadow: 0 0 8px #00ff88;
            animation: pulse 2s infinite;
        }

        .status-waiting {
            background: #ffaa00;
        }

        .status-outofrange {
            background: #ff4444;
            animation: blink 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .range-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .range-box {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid;
        }

        .upper-range {
            background: rgba(255, 68, 68, 0.1);
            border-color: #ff4444;
        }

        .lower-range {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
        }

        .range-label {
            font-size: 11px;
            color: #8e8ea9;
            margin-bottom: 4px;
        }

        .range-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .chart-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a3e;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            color: #00d4ff;
            font-size: 18px;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
        }

        .time-filter {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
        }

        .time-btn {
            background: transparent;
            color: #8e8ea9;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .time-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .time-btn.active {
            background: #00d4ff;
            color: #0f0f1e;
        }

        .chart-type-toggle {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
        }

        .type-btn {
            background: transparent;
            color: #8e8ea9;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .type-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .type-btn.active {
            background: #00d4ff;
            color: #0f0f1e;
        }

        #chart-container {
            height: 650px;
            margin-top: 10px;
        }

        .distribution {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .dist-card {
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .weth-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .usdc-card {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.2), rgba(39, 174, 96, 0.2));
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .dist-label {
            font-size: 11px;
            color: #8e8ea9;
            margin-bottom: 4px;
        }

        .dist-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .last-update {
            text-align: center;
            color: #8e8ea9;
            margin-top: 20px;
            font-size: 12px;
        }

        .data-table-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a3e;
            margin-top: 20px;
        }

        .data-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .data-table-title {
            color: #00d4ff;
            font-size: 18px;
            font-weight: 600;
        }

        .data-toggle {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
        }

        .data-toggle-btn {
            background: transparent;
            color: #8e8ea9;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .data-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .data-toggle-btn.active {
            background: #00d4ff;
            color: #0f0f1e;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table thead {
            background: rgba(0, 212, 255, 0.1);
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            color: #00d4ff;
            font-weight: 600;
            border-bottom: 2px solid #00d4ff;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .table-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 13px;
        }

        .table-stat {
            display: flex;
            gap: 8px;
        }

        .table-stat-label {
            color: #8e8ea9;
        }

        .table-stat-value {
            color: #00d4ff;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-open {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .status-range-up {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .status-range-down {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .price-up {
            color: #26a69a;
        }

        .price-down {
            color: #ef5350;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .pagination-info {
            color: #8e8ea9;
            font-size: 13px;
        }

        .pagination-buttons {
            display: flex;
            gap: 8px;
        }

        .page-btn {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(0, 212, 255, 0.2);
            transform: translateY(-1px);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: #00d4ff;
            color: #0f0f1e;
        }

        .page-numbers {
            display: flex;
            gap: 4px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #0f0f1e;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 212, 255, 0.4);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-live {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                SurfLiquid Velocity Flow - WETH/USDC Monitor
                <span class="badge badge-live">‚óè LIVE</span>
            </h1>
            <div class="pool-info">
                <span><strong>Pool:</strong> 0x6fb3...0b40</span>
                <span><strong>DEX:</strong> Shadow</span>
                <span><strong>Network:</strong> Sonic</span>
                <span><strong>Interval:</strong> 15s</span>
                <span><strong>Range:</strong> ¬±0.1%</span>
                <span><strong>Source:</strong> On-Chain RPC</span>
            </div>
        </header>

        <div class="main-grid">
            <div class="sidebar">
                <div class="card">
                    <h2>üí∞ Current Price</h2>
                    <div class="price-large" id="currentPrice">$0.00</div>
                    <div class="stat">
                        <span class="stat-label">24h Change:</span>
                        <span class="stat-value" id="priceChange">+0.00%</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">TVL (Liquidity):</span>
                        <span class="stat-value" id="liquidity">$0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">WETH:</span>
                        <span class="stat-value" id="wethAmount">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">USDC:</span>
                        <span class="stat-value" id="usdcAmount">0</span>
                    </div>
                </div>

                <div class="card">
                    <h2>üìç Position Status</h2>
                    <div class="stat">
                        <span class="stat-label">Status:</span>
                        <span class="stat-value" id="positionStatus">
                            <span class="status-indicator"></span>No Position
                        </span>
                    </div>
                    <div class="range-info">
                        <div class="range-box upper-range">
                            <div class="range-label">Upper Range</div>
                            <div class="range-value" id="upperRange">$0</div>
                        </div>
                        <div class="range-box lower-range">
                            <div class="range-label">Lower Range</div>
                            <div class="range-value" id="lowerRange">$0</div>
                        </div>
                    </div>
                    <div class="stat" style="margin-top: 16px;">
                        <span class="stat-label">Rebalance Type:</span>
                        <span class="stat-value" id="rebalanceType">N/A</span>
                    </div>
                </div>

                <div class="card">
                    <h2>üîÑ Token Distribution</h2>
                    <div class="distribution">
                        <div class="dist-card weth-card">
                            <div class="dist-label">WETH</div>
                            <div class="dist-value" id="wethPct">50%</div>
                        </div>
                        <div class="dist-card usdc-card">
                            <div class="dist-label">USDC</div>
                            <div class="dist-value" id="usdcPct">50%</div>
                        </div>
                    </div>
                </div>

                <button class="refresh-btn" onclick="location.reload()">üîÑ Refresh</button>
            </div>

            <div class="chart-section">
                <div class="chart-header">
                    <h2 class="chart-title">üìä Price Chart - 15s Candles</h2>
                    <div class="chart-controls">
                        <div class="time-filter">
                            <button class="time-btn active" data-range="15m">15m</button>
                            <button class="time-btn" data-range="1h">1H</button>
                            <button class="time-btn" data-range="4h">4H</button>
                            <button class="time-btn" data-range="24h">24H</button>
                            <button class="time-btn" data-range="all">All</button>
                        </div>
                        <div class="time-filter" style="margin-left: 12px;">
                            <button class="time-btn" onclick="zoomChart(1.2)" title="Zoom In">üîç+</button>
                            <button class="time-btn" onclick="zoomChart(0.8)" title="Zoom Out">üîç-</button>
                            <button class="time-btn" onclick="resetZoom()" title="Reset Zoom">‚ü≤</button>
                        </div>
                        <div class="chart-type-toggle">
                            <button class="type-btn active" data-type="candle">üïØÔ∏è Candles</button>
                            <button class="type-btn" data-type="line">üìà Line</button>
                        </div>
                    </div>
                </div>
                <div id="chart-container"></div>
            </div>
        </div>

        <div class="data-table-section">
            <div class="data-table-header">
                <h2 class="data-table-title">üìã Historical Data</h2>
                <div class="data-toggle">
                    <button class="data-toggle-btn active" data-view="candles">üïØÔ∏è Candles</button>
                    <button class="data-toggle-btn" data-view="positions">üìç Positions</button>
                </div>
            </div>

            <div class="table-stats" id="tableStats">
                <div class="table-stat">
                    <span class="table-stat-label">Total Records:</span>
                    <span class="table-stat-value" id="totalRecords">0</span>
                </div>
                <div class="table-stat">
                    <span class="table-stat-label">Showing:</span>
                    <span class="table-stat-value" id="showingRecords">0</span>
                </div>
                <div class="table-stat">
                    <span class="table-stat-label">Latest:</span>
                    <span class="table-stat-value" id="latestRecord">-</span>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="pagination-controls">
                <div class="pagination-info" id="paginationInfo">
                    Page 1 of 1
                </div>
                <div class="pagination-buttons">
                    <button class="page-btn" id="prevPage" onclick="changePage(-1)">‚Üê Previous</button>
                    <div class="page-numbers" id="pageNumbers"></div>
                    <button class="page-btn" id="nextPage" onclick="changePage(1)">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <div class="last-update">
            Last updated: <span id="lastUpdate">Never</span>
        </div>
    </div>

    <script>
        let chart = null;
        let candlestickSeries = null;
        let lineSeries = null;
        let upperRangeLine = null;
        let lowerRangeLine = null;
        let currentChartType = 'candle';
        let currentTimeRange = '15m';
        let allCandles = [];

        // Initialize chart
        function initChart() {
            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: { color: '#16213e' },
                    textColor: '#8e8ea9',
                },
                grid: {
                    vertLines: { color: '#2a2a3e' },
                    horzLines: { color: '#2a2a3e' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: {
                        width: 1,
                        color: '#758696',
                        style: LightweightCharts.LineStyle.Dashed,
                    },
                    horzLine: {
                        width: 1,
                        color: '#758696',
                        style: LightweightCharts.LineStyle.Dashed,
                    },
                },
                rightPriceScale: {
                    borderColor: '#2a2a3e',
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0.2,
                    },
                    autoScale: true,
                    mode: LightweightCharts.PriceScaleMode.Normal,
                },
                timeScale: {
                    borderColor: '#2a2a3e',
                    timeVisible: true,
                    secondsVisible: false,
                    rightOffset: 12,
                    barSpacing: 12,
                    minBarSpacing: 4,
                    fixLeftEdge: false,
                    fixRightEdge: false,
                    lockVisibleTimeRangeOnResize: true,
                    shiftVisibleRangeOnNewBar: true,
                },
                handleScroll: {
                    mouseWheel: true,
                    pressedMouseMove: true,
                    horzTouchDrag: true,
                    vertTouchDrag: true,
                },
                handleScale: {
                    axisPressedMouseMove: {
                        time: true,
                        price: true,
                    },
                    axisDoubleClickReset: {
                        time: true,
                        price: true,
                    },
                    mouseWheel: true,
                    pinch: true,
                },
                kineticScroll: {
                    mouse: true,
                    touch: true,
                },
            });

            // Create candlestick series with better visibility
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                priceFormat: {
                    type: 'price',
                    precision: 2,
                    minMove: 0.01,
                },
            });

            // Create line series (hidden initially)
            lineSeries = chart.addLineSeries({
                color: '#00d4ff',
                lineWidth: 2,
                visible: false,
            });

            // Add range lines as overlays (won't affect main price scale)
            upperRangeLine = chart.addLineSeries({
                color: '#ef5350',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                title: 'Upper Range',
                priceLineVisible: false,
                lastValueVisible: true,
                priceScaleId: '', // Use main price scale
            });

            lowerRangeLine = chart.addLineSeries({
                color: '#26a69a',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                title: 'Lower Range',
                priceLineVisible: false,
                lastValueVisible: true,
                priceScaleId: '', // Use main price scale
            });

            // Make chart responsive
            window.addEventListener('resize', () => {
                chart.applyOptions({ width: container.clientWidth });
            });
        }

        // Filter candles by time range
        function filterCandlesByTimeRange(candles, range) {
            if (!candles || candles.length === 0) return [];

            if (range === 'all') {
                return candles; // Return all candles
            }

            const now = Date.now();
            let cutoffTime;

            switch(range) {
                case '15m':
                    cutoffTime = now - (15 * 60 * 1000);
                    break;
                case '1h':
                    cutoffTime = now - (60 * 60 * 1000);
                    break;
                case '4h':
                    cutoffTime = now - (4 * 60 * 60 * 1000);
                    break;
                case '24h':
                    cutoffTime = now - (24 * 60 * 60 * 1000);
                    break;
                default:
                    cutoffTime = now - (60 * 60 * 1000);
            }

            return candles.filter(c => c.timestamp >= cutoffTime);
        }

        // Zoom functions
        function zoomChart(factor) {
            const timeScale = chart.timeScale();
            const logicalRange = timeScale.getVisibleLogicalRange();

            if (logicalRange) {
                const center = (logicalRange.from + logicalRange.to) / 2;
                const newWidth = (logicalRange.to - logicalRange.from) / factor;

                timeScale.setVisibleLogicalRange({
                    from: center - newWidth / 2,
                    to: center + newWidth / 2,
                });
            }
        }

        function resetZoom() {
            chart.timeScale().fitContent();
        }

        // Update chart with candle data
        function updateChart(candles, position) {
            if (!candles || candles.length === 0) return;

            // Filter by time range
            const filteredCandles = filterCandlesByTimeRange(candles, currentTimeRange);

            if (filteredCandles.length === 0) return;

            // Convert to TradingView format
            const candleData = filteredCandles.map(c => ({
                time: Math.floor(c.timestamp / 1000),
                open: parseFloat(c.open),
                high: parseFloat(c.high),
                low: parseFloat(c.low),
                close: parseFloat(c.close)
            }));

            const lineData = filteredCandles.map(c => ({
                time: Math.floor(c.timestamp / 1000),
                value: parseFloat(c.close)
            }));

            // Update series based on chart type
            if (currentChartType === 'candle') {
                candlestickSeries.setData(candleData);
            } else {
                lineSeries.setData(lineData);
            }

            // Update range lines if position exists - only show for last 15 minutes
            if (position) {
                const now = Date.now();
                const recentCutoff = now - (15 * 60 * 1000); // Last 15 minutes only

                const recentCandles = filteredCandles.filter(c => c.timestamp >= recentCutoff);

                const upperRangeData = recentCandles.map(c => ({
                    time: Math.floor(c.timestamp / 1000),
                    value: position.upper_range
                }));

                const lowerRangeData = recentCandles.map(c => ({
                    time: Math.floor(c.timestamp / 1000),
                    value: position.lower_range
                }));

                upperRangeLine.setData(upperRangeData);
                lowerRangeLine.setData(lowerRangeData);

                // Create markers for current price vs range
                const lastCandle = filteredCandles[filteredCandles.length - 1];
                if (lastCandle) {
                    const markers = [];
                    const lastTime = Math.floor(lastCandle.timestamp / 1000);

                    if (lastCandle.close > position.upper_range) {
                        markers.push({
                            time: lastTime,
                            position: 'aboveBar',
                            color: '#ef5350',
                            shape: 'arrowDown',
                            text: 'Above Range',
                        });
                    } else if (lastCandle.close < position.lower_range) {
                        markers.push({
                            time: lastTime,
                            position: 'belowBar',
                            color: '#26a69a',
                            shape: 'arrowUp',
                            text: 'Below Range',
                        });
                    }

                    candlestickSeries.setMarkers(markers);
                }
            }

            // Auto-scale price if needed
            if (currentTimeRange === '15m' || currentTimeRange === '1h') {
                chart.priceScale('right').applyOptions({
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0.2,
                    },
                });
            }

            // Only fit content on initial load or range change, not on updates
            if (!window.chartInitialized) {
                chart.timeScale().fitContent();
                window.chartInitialized = true;
            } else {
                // Scroll to show latest data
                chart.timeScale().scrollToRealTime();
            }
        }

        // Update dashboard
        async function updateDashboard() {
            try {
                const [currentResponse, candlesResponse] = await Promise.all([
                    // Use relative URLs so this works from any host (server IP, domain, or localhost)
                    fetch('/api/current'),
                    fetch('/api/candles')
                ]);

                const currentData = await currentResponse.json();
                const candlesData = await candlesResponse.json();

                // Store all candles
                allCandles = candlesData;

                // Update current price and stats
                if (currentData.currentCandle) {
                    const candle = currentData.currentCandle;
                    const price = candle.close;
                    document.getElementById('currentPrice').textContent = `$${price.toFixed(2)}`;

                    // Calculate TVL: (WETH amount * WETH price) + USDC amount
                    const tvl = (candle.weth_amount * price) + candle.usdc_amount;
                    document.getElementById('liquidity').textContent = `$${tvl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                    document.getElementById('wethAmount').textContent = candle.weth_amount.toFixed(4);
                    document.getElementById('usdcAmount').textContent = candle.usdc_amount.toFixed(2);
                }

                // Update position status
                if (currentData.position) {
                    const pos = currentData.position;
                    let statusClass = 'status-indicator';
                    let statusText = pos.status;

                    if (pos.status.includes('Open')) {
                        statusClass += ' status-open';
                    } else if (pos.status.includes('Waiting')) {
                        statusClass += ' status-waiting';
                    } else if (pos.status.includes('Out of Range')) {
                        statusClass += ' status-outofrange';
                    }

                    document.getElementById('positionStatus').innerHTML =
                        `<span class="${statusClass}"></span>${statusText}`;
                    document.getElementById('upperRange').textContent = `$${pos.upper_range.toFixed(2)}`;
                    document.getElementById('lowerRange').textContent = `$${pos.lower_range.toFixed(2)}`;
                    document.getElementById('rebalanceType').textContent = pos.rebalance_type || 'N/A';

                    // Update distribution
                    const wethPct = pos.weth_pct.toFixed(1);
                    const usdcPct = pos.usdc_pct.toFixed(1);
                    document.getElementById('wethPct').textContent = `${wethPct}%`;
                    document.getElementById('usdcPct').textContent = `${usdcPct}%`;

                    // Update chart
                    updateChart(allCandles, pos);
                }

                // Update timestamp
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // Time range filter buttons
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!this.dataset.range) return; // Skip zoom buttons

                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTimeRange = this.dataset.range;

                // Load all data from MongoDB if "All" is selected
                if (currentTimeRange === 'all') {
                    try {
                        const response = await fetch('/api/db/candles?page=1&limit=1000');
                        const result = await response.json();
                        allCandles = result.data;
                    } catch (error) {
                        console.error('Error loading all candles:', error);
                    }
                }

                window.chartInitialized = false; // Force fit content on range change
                updateChart(allCandles, null); // Will get position from next update
            });
        });

        // Chart type toggle
        document.querySelectorAll('.type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentChartType = this.dataset.type;

                if (currentChartType === 'candle') {
                    candlestickSeries.applyOptions({ visible: true });
                    lineSeries.applyOptions({ visible: false });
                } else {
                    candlestickSeries.applyOptions({ visible: false });
                    lineSeries.applyOptions({ visible: true });
                }
            });
        });

        // Data table functionality
        let currentDataView = 'candles';
        let currentPage = 1;
        let totalPages = 1;
        let dbStats = { candleCount: 0, positionCount: 0 };

        async function fetchDBStats() {
            try {
                const response = await fetch('/api/db/stats');
                dbStats = await response.json();
            } catch (error) {
                console.error('Error fetching DB stats:', error);
            }
        }

        async function loadTableData(view, page = 1) {
            currentDataView = view;
            currentPage = page;

            try {
                const endpoint = view === 'candles' ?
                    `/api/db/candles?page=${page}&limit=100` :
                    `/api/db/positions?page=${page}&limit=100`;

                const response = await fetch(endpoint);
                const result = await response.json();

                if (view === 'candles') {
                    displayCandlesTable(result.data);
                } else {
                    displayPositionsTable(result.data);
                }

                // Update pagination
                totalPages = result.pagination.totalPages;
                updatePaginationControls(result.pagination);

                // Update stats
                document.getElementById('totalRecords').textContent = result.pagination.totalCount.toLocaleString();
                document.getElementById('showingRecords').textContent = result.data.length.toLocaleString();

                if (result.data.length > 0) {
                    const latest = new Date(result.data[result.data.length - 1].timestamp);
                    document.getElementById('latestRecord').textContent = latest.toLocaleString();
                }
            } catch (error) {
                console.error('Error loading table data:', error);
            }
        }

        function updatePaginationControls(pagination) {
            // Update info text
            document.getElementById('paginationInfo').textContent =
                `Page ${pagination.page} of ${pagination.totalPages} (${pagination.totalCount} total records)`;

            // Update buttons state
            document.getElementById('prevPage').disabled = pagination.page === 1;
            document.getElementById('nextPage').disabled = pagination.page === pagination.totalPages;

            // Update page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';

            // Show up to 5 page numbers
            const maxButtons = 5;
            let startPage = Math.max(1, pagination.page - 2);
            let endPage = Math.min(pagination.totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = 'page-btn' + (i === pagination.page ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => loadTableData(currentDataView, i);
                pageNumbers.appendChild(btn);
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                loadTableData(currentDataView, newPage);
            }
        }

        function displayCandlesTable(candles) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            // Create table header
            thead.innerHTML = `
                <tr>
                    <th>Timestamp</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>Close</th>
                    <th>Change</th>
                    <th>TVL</th>
                    <th>WETH</th>
                    <th>USDC</th>
                </tr>
            `;

            // Create table rows
            tbody.innerHTML = candles.slice(-100).reverse().map(candle => {
                const change = candle.close - candle.open;
                const changePercent = ((change / candle.open) * 100).toFixed(3);
                const changeClass = change >= 0 ? 'price-up' : 'price-down';
                const changeSymbol = change >= 0 ? '‚ñ≤' : '‚ñº';

                // Calculate TVL
                const tvl = (parseFloat(candle.weth_amount) * parseFloat(candle.close)) + parseFloat(candle.usdc_amount);

                return `
                    <tr>
                        <td>${new Date(candle.timestamp).toLocaleString()}</td>
                        <td>$${parseFloat(candle.open).toFixed(2)}</td>
                        <td>$${parseFloat(candle.high).toFixed(2)}</td>
                        <td>$${parseFloat(candle.low).toFixed(2)}</td>
                        <td>$${parseFloat(candle.close).toFixed(2)}</td>
                        <td class="${changeClass}">${changeSymbol} ${changePercent}%</td>
                        <td>$${tvl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${parseFloat(candle.weth_amount).toFixed(4)}</td>
                        <td>$${parseFloat(candle.usdc_amount).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayPositionsTable(positions) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            // Create table header
            thead.innerHTML = `
                <tr>
                    <th>Timestamp</th>
                    <th>Status</th>
                    <th>Price</th>
                    <th>Upper Range</th>
                    <th>Lower Range</th>
                    <th>WETH %</th>
                    <th>USDC %</th>
                    <th>Rebalance Type</th>
                </tr>
            `;

            // Create table rows
            tbody.innerHTML = positions.slice(-100).reverse().map(pos => {
                let statusClass = 'status-badge ';
                if (pos.status.includes('Open')) {
                    statusClass += 'status-open';
                } else if (pos.status.includes('UP')) {
                    statusClass += 'status-range-up';
                } else if (pos.status.includes('DOWN')) {
                    statusClass += 'status-range-down';
                }

                return `
                    <tr>
                        <td>${new Date(pos.timestamp).toLocaleString()}</td>
                        <td><span class="${statusClass}">${pos.status}</span></td>
                        <td>$${parseFloat(pos.price).toFixed(2)}</td>
                        <td>$${parseFloat(pos.upper_range).toFixed(2)}</td>
                        <td>$${parseFloat(pos.lower_range).toFixed(2)}</td>
                        <td>${parseFloat(pos.weth_pct).toFixed(2)}%</td>
                        <td>${parseFloat(pos.usdc_pct).toFixed(2)}%</td>
                        <td>${pos.rebalance_type || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Data toggle buttons
        document.querySelectorAll('.data-toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.data-toggle-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPage = 1; // Reset to page 1 when switching views
                loadTableData(this.dataset.view, 1);
            });
        });

        // Initialize
        initChart();
        updateDashboard();
        fetchDBStats().then(() => loadTableData('candles', 1));

        // Update every 5 seconds
        setInterval(updateDashboard, 5000);
        setInterval(() => {
            fetchDBStats().then(() => loadTableData(currentDataView, currentPage));
        }, 10000); // Refresh table every 10 seconds
    </script>
</body>
</html>
